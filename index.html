<!DOCTYPE HTML>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>OfflineAudioContext leaks</title>
<style>
#subject {
    font-size: 20px;
}
.btn {font-size: 20px} 

#mainBtn {background-color: #f44336;}
#iframeBtn {background-color: #008CBA;}
#mainPBtn {background-color: #d7da33;}
#iframePBtn {background-color:#4CAF50;}
#rounds {
    font-size: 20px;
    color:rgb(14, 38, 191);
}
</style>
</head>
<body>
<h3>OfflineAudioContext Leaks</h3>
<div id="subject"></div>
<div id="progress">loading</div>
<div id="result"></div>
<div id="rounds"></div>
<button class="btn" id="mainBtn" disabled>Main</button>
<button class="btn" id="iframeBtn" disabled>IFrame</button>
<button class="btn" id="mainPBtn" disabled>Main with bypasser</button>
<button class="btn" id="iframePBtn" disabled>IFrame with bypasser</button>

<script>
var audioCtx = new(window.AudioContext || window.webkitAudioContext)();

// define variables
var subject = document.querySelector('#subject');
var result = document.querySelector('#result');
var progress = document.querySelector('#progress');
var rounds = document.querySelector('#rounds');
var mainBtn = document.querySelector('#mainBtn');
var iframeBtn = document.querySelector('#iframeBtn');
var mainPBtn = document.querySelector('#mainPBtn');
var iframePBtn = document.querySelector('#iframePBtn');
var myBuffer = null;
var useIFrame = false;
var useBypass = false;

// use XHR to load an audio track, and
// decodeAudioData to decode it and stick it in a buffer.
// Then we put the buffer into the source
function getData() {
    request = new XMLHttpRequest();
    request.open('GET', 'https://raw.githubusercontent.com/chensherlock/audiocontextleak/master/music.mp3', true);
    request.responseType = 'arraybuffer';
    request.onload = function() {
        progress.innerText = 'LOADED';
        var audioData = request.response;
        audioCtx.decodeAudioData(audioData, function(databuffer) {
            myBuffer = databuffer;
            enableButtons();
        }).catch(function(err) {
            console.log('Rendering failed: ' + err);
        });
    }
    request.send();
}

progress.innerText = 'LOADING...';
var count = 0;

function doTask() {
    if (useIFrame) {
        IFrameReload();
    } else {
        createBuffer();
    }
}

function createBuffer() {
    if (useIFrame) {
        var offlineCtx = getIFrameOfflineContext(2, myBuffer.length, myBuffer.sampleRate);
    } else {
        var offlineCtx = new OfflineAudioContext(2, myBuffer.length, myBuffer.sampleRate);
    }

    if (useBypass) {
        offlineCtx.audioWorklet.addModule('bypass.js').then(() => {
            var source = offlineCtx.createBufferSource();
            var bypasser = new AudioWorkletNode(offlineCtx, 'bypass-processor');
            source.buffer = myBuffer;
            source.connect(bypasser).connect(offlineCtx.destination);
            source.start();
            offlineCtx.startRendering().then(function(renderedBuffer) {
                result.innerHTML = 'Duration=' + renderedBuffer.duration + 's<BR>Length=' + (renderedBuffer.length / 1024 / 1024).toFixed(3) + 'MB';
                if (performance.memory) {
                    progress.innerHTML = 'usedJSHeapSize=' + (performance.memory.usedJSHeapSize / 1024 / 1024).toFixed(3)+ 'MB';
                }
                source.disconnect();
                bypasser.disconnect();
                count++;
                rounds.innerText = 'Round ' + count;
                setTimeout(doTask, 1000);
            }).catch(function(err) {
                document.body.style.backgroundColor = "#f7b2b0";
                result.innerText = 'Rendering failed: ' + err;
            });
        });
    } else {
        var source = offlineCtx.createBufferSource();
        source.buffer = myBuffer;
        source.connect(offlineCtx.destination);
        source.start();
        offlineCtx.startRendering().then(function(renderedBuffer) {
            result.innerHTML = 'Duration=' + renderedBuffer.duration + 's<BR>Length=' + (renderedBuffer.length / 1024 / 1024).toFixed(3) + 'MB';
            if (performance.memory) {
                progress.innerHTML = 'usedJSHeapSize=' + (performance.memory.usedJSHeapSize / 1024 / 1024).toFixed(3)+ 'MB';
            }
            source.disconnect();
            count++;
            rounds.innerText = 'Round ' + count;
            setTimeout(doTask, 1000);
        }).catch(function(err) {
            document.body.style.backgroundColor = "#f7b2b0";
            result.innerText = 'Rendering failed: ' + err;
        });
    }
}

function enableButtons() {
    buttons = document.querySelectorAll(".btn");
    buttons.forEach(button => button.removeAttribute('disabled'));
}

function hideButtons() {
    buttons = document.querySelectorAll(".btn");
    buttons.forEach(button => button.setAttribute('disabled', 'disabled'));
}


function doClick(text, i, b) {
    subject.innerText = text;
    hideButtons();
    useIFrame = i;
    useBypass = b;
    createBuffer();
}

mainBtn.onclick = function() { doClick('Main', false, false) };
iframeBtn.onclick = function() { doClick('IFrame', true, false) };
mainPBtn.onclick = function() { doClick('Main with Bypasser', false, true) };
iframePBtn.onclick = function() { doClick('IFrame with Bypasser', true, true) };

function createIframe() {
    iFrame = document.createElement('iframe');
    iFrame.style.display = 'none';
    iFrame.onload = () => {
        const script = document.createElement('script');
        script.innerHTML =
          `
            function reload() {
              location.reload();
            }

            function createOfflineContext(NUMBER_OF_CHANNEL, duration, sampleRate) {
              return new (window.OfflineAudioContext || window.webkitOfflineAudioContext)(NUMBER_OF_CHANNEL,duration,sampleRate);
            }
          `;
        iFrame.contentDocument.body.appendChild(script);
    };
    document.body.appendChild(iFrame);
}

function getIFrameOfflineContext(NUMBER_OF_CHANNEL, duration, sampleRate) {
    if (!iFrame) {
        createIframe();
    }
    return iFrame.contentWindow.createOfflineContext(NUMBER_OF_CHANNEL, duration, sampleRate);
}

function IFrameReload() {
    iFrame.contentWindow.reload();
    setTimeout(createBuffer, 1000);
}

var iFrame;
getData();

</script>
</body>
</html>
